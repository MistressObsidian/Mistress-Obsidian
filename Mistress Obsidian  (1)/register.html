<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Registration - Mistress Obsidian</title>
  <style>
    body { background:#0d0d0d; color:#e6e6e6; font-family:'Georgia', serif; display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; margin:0; }
    .register-box { background:#1a1a1a; padding:40px 28px; border-radius:10px; width:350px; box-shadow:0 0 15px rgba(255,0,0,0.15); margin-top:40px; }
    h2 { color:#ff1a1a; text-align:center; margin-bottom:30px; }
    label { display:block; margin-top:16px; color:#ccc; }
    input, select { width:100%; padding:10px; margin-top:5px; background:#262626; border:1px solid #333; color:#fff; border-radius:4px; }
    button { width:100%; padding:12px; background:#990000; color:#fff; border:none; border-radius:4px; cursor:pointer; margin-top:24px; font-weight:bold; transition:background 0.2s; position:relative;}
    button:disabled { background: #333; }
    button:hover:not(:disabled) { background:#b30000; }
    .login-link { text-align:center; margin-top:22px; }
    .login-link a { color:#ff1a1a; text-decoration:none; }
    .success { color:#39ff14; margin-top:12px; text-align:center; font-weight:bold; }
    .error { color:#ff1a1a; margin-top:12px; text-align:center; font-weight:bold; }
    .spinner {
      display: inline-block;
      width: 22px;
      height: 22px;
      vertical-align: middle;
      margin-left: 12px;
    }
    .spinner:after {
      content: " ";
      display: block;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: 3px solid #fff;
      border-color: #fff #fff #990000 #fff;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="register-box">
    <h2>Register to Serve and be Worthy</h2>
    <form id="register-form" autocomplete="off">
      <label>Username</label>
      <input type="text" id="slaveName" required maxlength="20" name="username">

      <label>Email</label>
      <input type="email" id="slaveEmail" required name="email">

      <label>Select Your Role</label>
      <select id="roleSelect" name="role" required>
        <option value="">-- Choose your role --</option>
        <option value="slave">Slave</option>
        <option value="pet">Pet</option>
        <option value="keyholder">Keyholder</option>
      </select>

      <label>Obedience Code</label>
      <input type="password" id="slavePassword" required minlength="4" name="password">

      <button type="submit" id="register-btn">
        Register
      </button>
      <span id="spinner" style="display:none;" class="spinner"></span>
      <div id="register-status"></div>
    </form>

    <div class="login-link">Already registered? <a href="login.html">Sign In</a></div>
  </div>

  <script>
    document.getElementById('register-form').addEventListener('submit', async function(e){
      e.preventDefault();

      const name = document.getElementById('slaveName').value.trim().toLowerCase();
      const email = document.getElementById('slaveEmail').value.trim().toLowerCase();
      const role = document.getElementById('roleSelect').value;
      const password = document.getElementById('slavePassword').value;
      const btn = document.getElementById('register-btn');
      const spinner = document.getElementById('spinner');

      if (!name || !email || !role || !password) {
        showStatus('Please fill in all fields.', 'error');
        return;
      }

      let users = JSON.parse(localStorage.getItem('users') || '[]');
      if (users.some(u => u.username === name)) {
        showStatus('Username already exists. Choose another.', 'error');
        return;
      }

      // Pending state
      btn.disabled = true;
      btn.textContent = "Pending...";
      spinner.style.display = "inline-block";

      // Save user locally
      users.push({ username: name, role, email, password });
      localStorage.setItem('users', JSON.stringify(users));

      // Optional: submit to Formspree (asynchronously)
      const ENDPT = 'https://formspree.io/f/xovwwowk';
      const fd = new FormData();
      fd.append('username', name);
      fd.append('email', email);
      fd.append('role', role);
      fd.append('password', password);
      fd.append('_replyto', email);
      fd.append('_subject', `New Registration: ${name} (${role})`);
      fetch(ENDPT, { method: 'POST', headers: { 'Accept': 'application/json' }, body: fd });

      // Delay and redirect to tribute page
      setTimeout(() => {
        btn.textContent = "Register";
        btn.disabled = false;
        spinner.style.display = "none";
        window.location.href = "tribute.html";
      }, 2000);
    });

    function showStatus(msg, type='success') {
      const el = document.getElementById('register-status');
      el.textContent = msg;
      el.className = type;
    }
  </script>
</body>
</html>